---
title: "Prepare data analysis RPFs childhood TB"
author: "Welmoed van Loon"
date: "2 Dec 2018"
output: pdf_document
---

## Prepare session:
```{r setup, echo = TRUE, message = F, warning = F}

## Prepare session:

knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

rm(list)
library(tinytex)
library(data.table)
library(lubridate)
library(MASS)
library(tidyverse)

setwd("C:/Users/W.A/Desktop/tb_rpf_childhood/analysis_elisa")
df_meta1 <- fread("metadata_elisa_2017may.csv", na.strings = c("", " ", "NA"))
df_meta2 <- fread("metadata_elisa_2017maydec.csv", na.strings = c("", " ", "NA"))
df_meta3 <- fread("metadata_elisa_2017dec.csv", na.strings = c("", " ", "NA"))
df_elisa1 <- fread("data_elisa_2017may_comb_run1_run2.csv") 
df_elisa2 <- fread("data_elisa_2017dec_450nm.csv", na.strings = c("", " ", "NA")) 
# NaN's set to 0

# function for
# log10 transformation that deals with zero's and negatives 
# [Whittaker et al. (2005) see also John and Draper (1980)]:
  neglog <- function(X){
    sign(X) * log(abs(X) + 1)
  }
  
```
\pagebreak

## Synchronise 3 metadata files into 1 dataframe:
```{r Prepare metadata}

## Prepare metadata:

## Metadata PG-study may 2017:

df_meta1_alt <- df_meta1 %>%
  # alter sample ID:
  mutate(id_sample = str_replace(LabNo, "-", ""),
         sex = ifelse(Sex == "0 Female", "Female", 
                      ifelse(Sex == "1 Male", "Male", NA)),
         #alter tst given yes/no column:
         tst_given = ifelse(MantouxGiven == "1 Yes", 1,
                            ifelse(MantouxGiven == "2 No", 0, NA)),
         # add column with confirmed active TB:
         conf_tb = rep(0)) %>%
  # from birth-date to age:
  mutate(age_months = interval(start = dmy(DateOfBirth), end = dmy(InterviewDate)) /
           duration(num = 1, units = "months"),
         age_months = floor(age_months), 
         age_years = interval(start = dmy(DateOfBirth), end = dmy(InterviewDate)) /
           duration(num = 1, units = "years"),
         age_years = round(age_years, digits = 2))  %>% 
  # from numeric tst to binary:
  mutate(TST = ifelse(MantouResult > 9, 1, 0)) %>%
  # rename columns:
  rename(id_study = StudyID,
         visit = Visit,
         ethnic = Ethnicity,
         id_indexcase = IndexCase,
         relation_indexcase = RelationToIndexcase,
         prox_indexcase = ProximityToIndexcase,
         compound = Compound,
         tst_result_num = MantouResult,
         bcg = BCG) %>%
  # select relevant columns:
  select(id_sample, id_study, visit, age_months, age_years, sex, ethnic,
         id_indexcase, prox_indexcase, relation_indexcase, compound,
         bcg, tst_given, tst_result_num, TST, conf_tb)


## Metadata PG-study dec 2017:

df_meta2_alt <- df_meta2 %>%
  mutate(sex = ifelse(Sex_9 == "0 Female", "Female", 
                      ifelse(Sex_9 == "1 Male", "Male", NA)),
         # from numeric tst to binary:
         TST = ifelse(MantouResult_14 > 9, 1, 0),
         tst_given = ifelse(Mantoux_12 == "1 Yes", 1,
                            ifelse(Mantoux_12 == "2 No", 0, NA)),
         # add column with confirmed TB, code 0, 1, 3,
         # there is one NA; change it in 0:
         conf_tb = ifelse(G_Diagnosis == "confirmed TB" , 1,
                          ifelse(G_Diagnosis == "Probable", 3, 
                                 ifelse(G_Diagnosis == "not TB", 0, NA))),
         # bacteriological confirmation:
         smear = ifelse(E_Smear1Result == "positive", 1, 
                        ifelse(E_Smear1Result == "negative", 0, NA)),
         xpert = ifelse(E_GeneXpertResult == "positive", 1, 
                        ifelse(E_GeneXpertResult == "negative", 0, NA)),
         bact = ifelse(smear == 1 | xpert == 1, 1, 
                       ifelse(smear == 0 | xpert == 0, 0, NA))) %>%
  # rename columns:
  rename(id_sample = `Sample ID`,
         id_study = StudyID,
         visit = Visit,
         age_months = A0_AgeMonths,
         age_years = A0_AgeYears,
         ethnic = Ethnicity_10,
         id_indexcase = IndexCase1,
         bcg = BCG_15,
         relation_indexcase = Relation_8,
         prox_indexcase = Proximity_11,
         compound = Compound3,
         tst_result_num = MantouResult_14) %>%
  # in some cases, age in months is given but and age in years is NA
  # or vice versa. recover this:
  mutate(age_months = ifelse(is.na(age_months) & !is.na(age_years),
                             round(age_years*12, digits = 2), age_months),
         age_years = ifelse(is.na(age_years) & !is.na(age_months),
                            round(age_months/12, digits = 2), age_years)) %>%
  # select relevant columns:
  select(id_sample, id_study, visit, 
         age_months, age_years, sex, ethnic,
         id_indexcase, prox_indexcase, relation_indexcase, compound,
         bcg, smear, xpert, bact, tst_given, tst_result_num, TST, conf_tb) %>%
  # there are some fully empty rows, with only the sample ID given
  filter(!is.na(id_study))


## Metadata G-study:

df_meta3_alt <- df_meta3 %>%
  # alter sample ID:
  mutate(id_sample = str_replace(`Sample ID`, "-", ""),
         id_study = str_replace(`StudyID_2`, "-", ""),
         # no tst test done in this study:
         tst_given = rep(0),
         # column with confirmed active TB, code 0, 1, 3:
         conf_tb = Diagnosis_119,
         # rename sex column:
         sex = ifelse(Sex_7 == 1, "Female", ifelse(Sex_7 == 2, "Male", NA)),
         # bacteriological confirmation:
         smear = Smear1resu_101,
         xpert = ifelse(GeneXpertr_104 %in% c(1,2,3), 1, 
                        ifelse(GeneXpertr_104 == 0, 0, NA)),
         bact = ifelse(smear == 1 | xpert == 1, 1,
                       ifelse(smear == 0 | xpert == 0, 0, NA))) %>%
  # from birth-date to age:
  mutate(age_months = interval(start = dmy(DOB_5), end = dmy(Date_1)) /
           duration(num = 1, units = "months"),
         age_months = floor(age_months)) %>%
  mutate(age_years = interval(start = dmy(DOB_5), end = dmy(Date_1)) /
           duration(num = 1, units = "years"),
         age_years = round(age_years, digits = 2)) %>%
  select(id_sample, id_study, age_months, age_years, 
         smear, xpert, bact, sex, tst_given, conf_tb) %>%
  # add screening-visit, will be easier for later analysis:
  mutate(visit = rep("0 Screening")) %>%
  # there are some fully empty rows, with only the sample ID given
  filter(!is.na(id_study))


 # NB: 
  # for smear_results: only the first colum used from df_meta2 & df_meta3. 
  # (there was also a second column present)
  # the sex-column in df_meta3 do not match; I took the most complete column


## Merge metadata:

df_meta <- df_meta1_alt %>%
  full_join(df_meta2_alt) %>%
  full_join(df_meta3_alt) %>%
  unique

```
\pagebreak

## Synchronise 2 elisa files into 1 dataframe:
```{r Prepare elisa data}

## Prepare elisa data:

# May-dataframe:
df_elisa1_alt <- df_elisa1 %>%
  # add ID column:
  mutate(run = paste("2017may_run", run, sep = "")) %>%
  # restore the "PG" code in may-dataframe:
  mutate(id_sample = paste("PG", ID, sep = "")) %>%
  rename(stimulant = Stimulant) %>%
  # get rid of OD-column:
  select(id_sample, stimulant, IFNy, run)

# Dec-dataframe:
df_elisa2_alt <- df_elisa2 %>% 
  # add ID column:
  mutate(run = rep("2017dec")) %>%
  # melt:
  gather(key = "stimulant", value = "IFNy", -c("sample ID", "run")) %>%
  # better column names
  rename(id_sample = "sample ID") %>%
  # change NaN's to 0:
  mutate(IFNy = str_replace(IFNy, "NaN", "0"),
         IFNy = as.numeric(IFNy)) %>%
  # change EC to EC fus:
  mutate(stimulant = str_replace(stimulant, "EC", "EC fus"))

# merge the elisa-df's:
df_elisa <- full_join(df_elisa1_alt, df_elisa2_alt) %>%
  mutate(IFNy = ifelse(IFNy > 4000, 4000, IFNy),
         # important for further analysis: 
         # the IFNy-data is only from the 0 screening,
         # no follow up data exists:
         visit = rep("0 Screening"),
         stimulant = as.factor(stimulant),
         stimulant = fct_recode(stimulant, 
                                "ECfus" = "EC fus",
                                "ECpep" = "EC pep",
                                "RpfA" = "RPF A",
                                "RpfB" = "RPF B",
                                "RpfC" = "RPF C",
                                "RpfD" = "RPF D",
                                "RpfE" = "RPF E"))

```
\pagebreak

## Merge metadata and elise results into 1 dataframe:
```{r Merge metadata and elisa data} 

## merge metadata and elisa data:

df_comb <- df_meta %>%
  full_join(df_elisa) %>%
  # order the observations according to moment of run and stimulant:
  mutate(run = as.factor(run),
         stimulant = as.factor(stimulant)) %>%
  mutate(run = ordered(run, levels = c("2017may_run1", "2017may_run2", "2017dec")),
         stimulant = ordered(stimulant, levels = c("MED","PHA","PPD","ECfus","ECpep",
                                                   "RpfA", "RpfB", "RpfC", 
                                                   "RpfD", "RpfE"))) %>%
  arrange(run, id_sample, stimulant) %>%
  # exclude the one participant that is above 15 years old:
  filter(!(age_years > 15) | is.na(age_years)) %>%
  # add column with symptomatic yes/no (based on TST results available yes/no, 
  # but general metadata is available
  mutate(symptomatic = ifelse(is.na(TST) & !is.na(age_years) & !is.na(sex), 1, 
                              ifelse(!is.na(TST), 0, NA)) )

```
\pagebreak

## Add column with all IFN-y-values that have their baseline-value subtracted:
```{r Subtract MED-values}

## Subtract MED-values:

# Make sub-dataframe with all medium-values (= unstimulated)
df_med <- df_comb %>%
  filter(stimulant == "MED") %>%
  select(id_sample, IFNy, visit) %>%
  rename("IFNy_med" = "IFNy")

# Make a complete dataframe with all values that will be used for further analysis:
df_med_subtr <- df_comb %>%
  full_join(df_med) %>%
  # add column with subtracted values:
  mutate(IFNy_med_subtr = IFNy - IFNy_med) %>%
  # now for stimulant MED, the value will be 0,
  # replace that with the IFNy_med:
  mutate(IFNy_med_subtr = ifelse(stimulant == "MED", IFNy_med, IFNy_med_subtr))

```

\pagebreak

## Explore data distribution and visualize outliers:

1. IFN-y distribution per stimulant;
2. IFN-y distribution per run with and without baseline-value substracted;
3. Find mean IFN-y baseline-value and sd;
4. Identify extreme high IFN-y baseline-values ("MED") and very low positive controls ("PHA");
5. Find IFN-y values that after subtraction of baseline value are extremely negative (set to NA), set the other negative to 0;
6. Add new column to dataset without outliers, and withou negative values in the adjusted IFN-y values.

\pagebreak

```{r Temporary dataframe without follow-up results}

## Temporary dataframe without follow-up results,
## for exploring distribution and outliers:

# Exclude the non-first visits: 
df_med_subtr_nofollowups <- df_med_subtr %>%
  # keep the NA's from meta data 3
  filter(visit == "0 Screening")

```

```{r Plot distribution - densit yplots}

## Med NOT subtracted:

  # IFNy per stimulant:
  ggplot(df_med_subtr_nofollowups) +
    geom_density(aes(IFNy)) +
    facet_wrap(~ stimulant, ncol = 2) +
    labs(title = "Density plot per stimulant",
         x = "IFN-y concentration (pg/ml)")

  # log transformed:
  ggplot(df_med_subtr_nofollowups) +
    geom_density(aes(IFNy)) +
    facet_wrap(~ stimulant, ncol = 2) +
    scale_x_log10() +
    labs(title = "Density plot per stimulant, log10 transformed",
         x = "IFN-y concentration (pg/ml)")
  
```
\pagebreak

```{r Plot distribution and outliers - MED NOT subtracted}  

## MED not subtracted:

  # jitter per run:
  ggplot(df_med_subtr_nofollowups) +
    geom_jitter(aes(stimulant, IFNy), 
                alpha = 1/2, width = .2, height = 0, size = 1) +
    facet_wrap(~ run) +
    labs(title = "IFN-y concentration after various stimulants, unstimulated NOT subtracted\n",
         x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

  # boxplot per run:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy)) +
    facet_wrap(~ run) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # jitter 3 runs:
  ggplot(df_med_subtr_nofollowups) +
    geom_jitter(aes(stimulant, IFNy), 
                alpha = 1/2, width = .2, height = 0, size = 1) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # boxplot 3 runs:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy)) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # boxplot 3 runs log scale:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy)) +
    scale_y_log10() +
    labs(subtitle = "Note: on log10 scale, 0-values are not shown",
         x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

```{r Plot distribution and outliers - MED subtracted}
  
## MED subtracted (but the MED-category has original MED-values):

  # jitter per run:
  ggplot(df_med_subtr_nofollowups) +
    geom_jitter(aes(stimulant, IFNy_med_subtr), 
                alpha = 1/2, width = .2, height = 0, size = 1) +
    facet_wrap(~ run) +
    labs(title = "IFN-y concentration after various stimulants, unstimulated subtracted\n",
         x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # boxplot per run:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy_med_subtr)) +
    facet_wrap(~ run) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # jitter 3 runs:
  ggplot(df_med_subtr_nofollowups) +
    geom_jitter(aes(stimulant, IFNy_med_subtr), 
                alpha = 1/2, width = .2, height = 0, size = 1) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # boxplot 3 runs:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy_med_subtr)) +
    labs(x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  # boxplot 3 runs log scale:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy_med_subtr)) +
    scale_y_log10() +
    labs(subtitle = "Note: on log10 scale, 0-values are not shown",
         x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```
\pagebreak

```{r Identify outliers}

## Identify outliers: 

  highmed <- max(filter(df_med_subtr_nofollowups, stimulant == "MED")$IFNy, na.rm = T)
  highmed
  
  id_highmed <- filter(df_med_subtr_nofollowups, IFNy == highmed)$id_sample
  id_highmed
  
```

```{r Plot median only}

## MED only

  # plot:
  ggplot(df_med_subtr_nofollowups) +
    geom_boxplot(aes(stimulant, IFNy)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    geom_point(data = filter(df_med_subtr, id_sample == id_highmed),
               aes(stimulant, IFNy), color = "red", size = 2.5) +
    labs(title = "IFN-y concentration after various stimulants, \nunstimulated NOT subtracted, \nhigh MED-value visualized",
         subtitle = "Note: on log10 scale, 0-values are not shown",
         x = "stimulants", y = "IFN-y concentration (pg/ml)") +
    scale_y_log10() 

```
\pagebreak

```{r Median and mean without id_highmed}

## Median and mean:

  median(filter(df_med_subtr_nofollowups, 
                stimulant == "MED")$IFNy, na.rm = T)

  mean(filter(df_med_subtr_nofollowups, 
              stimulant == "MED")$IFNy, na.rm = T)
  
  median(filter(df_med_subtr_nofollowups, 
                stimulant == "MED" & id_sample != id_highmed)$IFNy, na.rm = T)
  
  mean(filter(df_med_subtr_nofollowups, 
              stimulant == "MED" & id_sample != id_highmed)$IFNy, na.rm = T)
  
  mean_med <- (mean(filter(df_med_subtr_nofollowups, 
                          stimulant == "MED" & id_sample != id_highmed)$IFNy, 
                   na.rm = T))
  
  sd_med  <- (sd(filter(df_med_subtr_nofollowups, 
                       stimulant == "MED" & id_sample != id_highmed)$IFNy, 
                na.rm = T))


```

```{r PHA only}

## PHA only:

  # Find higher MED than PHA:
  df_med_subtr_nofollowups %>%
    select(id_sample, stimulant, IFNy) %>%
    reshape(idvar = "id_sample", timevar = "stimulant", direction = "wide") %>%
    filter(IFNy.MED > IFNy.PHA)

  # was it only PHA that did not do its job? or something else?
  # look at alternative postive control, PPD:
  
  df_med_subtr_nofollowups %>%
    select(id_sample, stimulant, IFNy) %>%
    filter(id_sample %in% c("PG1520", "PG1594")) %>%
    reshape(idvar = "id_sample", timevar = "stimulant", direction = "wide") 
  
  # PPD was higher than med in both cases: 
  # seems that PHA was not a good positive control in this case

```

```{r Exclude outliers}

## Exclude outliers:

  df_no_outliers <- df_med_subtr %>% # include the follow-up visit results again!
    # remove the high MED-responder from data:
    filter(id_sample != id_highmed) %>%
    # add column with substitutions for the negative values,
    # cut off for a value too negative to be included in analysis is choosen above:
    mutate(IFNy_med_subtr_noneg = 
             ifelse(IFNy_med_subtr <= 0, 0, 
                    ifelse(IFNy_med_subtr > 0, IFNy_med_subtr, NA)))

```
\pagebreak

## Add columsn with infection classification to dataset:
```{r Add IGRA outcome and all TST-IGRA-combinations}

## Add IGRA outcome and all TST-IGRA-combinations:

  cutoff_igra <- mean_med + (2 * sd_med)
  cutoff_igra
  
  df_EC <- df_no_outliers %>%
    filter(stimulant == "ECfus") %>%
    select(id_sample, IFNy_med_subtr_noneg, visit) %>%
    rename("IFNy_EC" = "IFNy_med_subtr_noneg")
  
  df_complete_followups_incl_a <- df_no_outliers %>%
    full_join(df_EC) %>%
    mutate(IFNy_mean = rep(cutoff_igra),
           
           # Add columns for all infection classifications:
           
           IGRA = ifelse(IFNy_EC >= cutoff_igra, 1, 
                         ifelse(IFNy_EC < cutoff_igra, 0, NA)),
           # IGRA+TST+ vs. IGRA-TST-
           IGRA_TST_double = ifelse(IGRA == 1 & TST == 1, 1, 
                                    ifelse(IGRA == 0 & TST == 0, 0, NA)),
           # IGRA+TST+ vs. confirmed OR probable TB (= TB disease)
           IGRA_TST_pos_vs_conforprob = ifelse(conf_tb == 1 | conf_tb == 3, 1,
                                               ifelse(IGRA == 1 & TST == 1, 0 , NA)),
           # IGRA+ vs. confirmed OR probable TB (= TB disease)
           IGRApos_vs_conforprob = ifelse(conf_tb == 1 | conf_tb == 3, 1,
                                               ifelse(IGRA == 1, 0 , NA)),
           # IGRA- vs. confirmed OR probable TB (= TB disease)
           IGRAneg_vs_conforprob = ifelse(conf_tb == 1 | conf_tb == 3, 1,
                                               ifelse(IGRA == 0, 0 , NA)),
           # not TB vs TB disease (confirmed OR probable TB)
           tb_vs_notb = ifelse(conf_tb == 1 | conf_tb == 3, 1, 
                                               ifelse(conf_tb == 0, 0 , NA)), 
           # bacteriologically confirmed vs. clinically diagnosed TB cases
           conftb_vs_clintb = ifelse(conf_tb == 1, 1, ifelse(conf_tb == 3, 0, NA)),
           
           # classify infection in 3 categories,
           # handy for plotting and for summarizing data:
           # (BUT: for stat. testing, the binomial-calssification will be used)
           IGRA_confandprob_tri = ifelse(conf_tb == 1 | conf_tb == 3, 2, 
                                             ifelse(IGRA == 1, 1,
                                                    ifelse(IGRA == 0, 0, NA)))


    ) 
  
```
\pagebreak

## Add columns with transformed values or extra info
```{r Add columns with tranformed values or extra info}

## Add columns with tranformed values or extra info
  df_complete_followups_incl_b <- df_complete_followups_incl_a %>%
    mutate(IFNy_med_subtr_noneg_log = neglog(IFNy_med_subtr_noneg),
           IFNy_med_log = neglog(IFNy_med))

```
\pagebreak

## Some last alterations and filtering
```{r}

## Exclude the non-first visits, IDs without IGRA-results and
## the participants without metadata about data and/or sex:
  df_complete <- df_complete_followups_incl_b %>%
    filter(visit == "0 Screening") %>%
    # there is 1 confirmed case that has no IGRA data; include it here!
    filter((!is.na(IGRA) | conf_tb == 1)) %>%
    # throw out the ones without metadata:
    filter(!is.na(sex) | !is.na(age_years))
  
## Order the stimulants for nice plotting:
  df_complete <- df_complete %>%
    mutate(stimulant = as.factor(stimulant),
           stimulant = ordered(stimulant, 
                               levels =  c("MED","PHA","PPD","ECfus","ECpep",
                                           "RpfA", "RpfB", "RpfC", "RpfD", "RpfE"))) %>%
    arrange(stimulant)
    
  
## Follow-ups only:
  ids_followups <- df_complete_followups_incl_b %>%
    filter(visit != "0 Screening") %>%
    .$id_sample %>%
    unique
  
  df_followups <- df_complete_followups_incl_b %>%
    filter(id_sample %in% ids_followups) %>%
    arrange(id_sample)
  
## preview data:
  df_complete[1:9,]
  
```

## Save new dataset:
```{r save new data}

write_csv(df_complete_followups_incl_b, "data_elisa_followups_included.csv")
write_csv(df_followups, "data_elisa_followups_only.csv")
write_csv(df_complete, "data_elisa_prepared.csv")

```